import{AsyncBarrier as e,loadCommonShaderSource as t,createShader as E,createGraphicsProgram as r,getUniformLocation as n,deleteShaders as R,loadF32Lines as i}from"../../util.js";function loadShaderSource(e){return fetch("./shaders/compiled/"+e).then(e=>e.text())}let _LOAD_BVH1=WebAssembly.instantiateStreaming(fetch("/res/bvh_v1.wasm")).then(e=>e.instance.exports),_LOAD_SIMPLE_LINES=i("/res/lines_simple0.f32"),_LOAD_MODERATE_LINES=i("/res/lines_moderate0.f32"),_LOAD_COMPLEX_LINES=i("/res/lines.f32");async function asyncBuildBVH(e,t){let E=await e,r=await t,n=r.length/4;if(!E.allocateLines(n)){var R=`Failed to allocate lines (num: ${n}).`;throw console.log(R),alert(R),Error(R)}new Float32Array(E.memory.buffer,E.getLinesBuffer(),r.length).set(r);let i=E.buildBvh(n);if(!i){var R="Failed to build BVH!";throw console.log(R),alert(R),Error(R)}let a=12*i,T=new Float32Array(E.memory.buffer,E.getBvhBuffer(),a),u=new Float32Array(a);return u.set(T),u}let _RESOURCES=new e().enqueue(_LOAD_SIMPLE_LINES,"SIMPLE_LINES").enqueue(_LOAD_MODERATE_LINES,"MODERATE_LINES").enqueue(_LOAD_COMPLEX_LINES,"COMPLEX_LINES").enqueue(asyncBuildBVH(_LOAD_BVH1,_LOAD_SIMPLE_LINES),"SIMPLE_LINES_BVH").enqueue(asyncBuildBVH(_LOAD_BVH1,_LOAD_MODERATE_LINES),"MODERATE_LINES_BVH").enqueue(asyncBuildBVH(_LOAD_BVH1,_LOAD_COMPLEX_LINES),"COMPLEX_LINES_BVH").enqueue(WebAssembly.instantiateStreaming(fetch("/res/number_formats.wasm")).then(e=>e.instance.exports),"NUMBER_FORMATS").enqueue(t("draw_rect.vert"),"DRAW_RECT_VERT_SRC").enqueue(t("draw_rect_uvs.vert"),"DRAW_RECT_UVS_VERT_SRC").enqueue(t("draw_col.frag"),"DRAW_COL_FRAG_SRC").enqueue(t("const_col.frag"),"CONST_COL_FRAG_SRC").enqueue(loadShaderSource("draw_lines.vert"),"DRAW_LINES_VERT_SRC").enqueue(loadShaderSource("draw_bbox.vert"),"DRAW_BBOX_VERT_SRC").enqueue(loadShaderSource("draw_lights_binary.frag"),"DRAW_LIGHTS_BINARY_FRAG_SRC").enqueue(loadShaderSource("draw_lights_pcf.frag"),"DRAW_LIGHTS_PCF_FRAG_SRC").enqueue(loadShaderSource("draw_lights_bbox.vert"),"DRAW_LIGHTS_BBOX_VERT_SRC").enqueue(loadShaderSource("draw_lights_obbox.vert"),"DRAW_LIGHTS_OBBOX_VERT_SRC").enqueue(loadShaderSource("draw_obbox.vert"),"DRAW_OBBOX_VERT_SRC").enqueue(loadShaderSource("gen_bbox.frag"),"GEN_BBOX_FRAG_SRC").enqueue(loadShaderSource("gen_obbox.frag"),"GEN_OBBOX_FRAG_SRC").enqueue(loadShaderSource("gen_plane_map.frag"),"GEN_PLANE_MAP_FRAG_SRC");class TextureFramebuffer{constructor(e,t,E,r,n,R,i,a){this.GL=e,this.width=n,this.height=R,this.texture=e.createTexture(),this.framebuffer=e.createFramebuffer(),e.bindTexture(e.TEXTURE_2D,this.texture),e.texImage2D(e.TEXTURE_2D,0,t,n,R,0,E,r,null),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,i),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,a),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.bindFramebuffer(e.FRAMEBUFFER,this.framebuffer),e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,this.texture,0);let T=e.checkFramebufferStatus(e.FRAMEBUFFER);if(T!=e.FRAMEBUFFER_COMPLETE){var u="Framebuffer marked as incomplete!";throw console.log(u),alert(u),Error(u)}e.bindFramebuffer(e.FRAMEBUFFER,null)}bind(e){let t=this.GL;t.viewport(0,0,this.width,this.height),t.bindFramebuffer(t.FRAMEBUFFER,this.framebuffer),t.drawBuffers([t.COLOR_ATTACHMENT0]),e()}destroy(){let e=this.GL;null!=this.framebuffer&&(e.deleteFramebuffer(this.framebuffer),this.framebuffer=null),null!=this.texture&&(e.deleteTexture(this.texture),this.texture=null)}}class CircularMappingCanvasContext{constructor(e){let t=e.getContext("webgl2",{alpha:!1,depth:!1,stencil:!1});if(this.hasFloatRenderTargets=t&&null!=t.getExtension("EXT_color_buffer_float"),this.hasFloatBlending=t&&null!=t.getExtension("EXT_float_blend"),this.canvas=e,this.valid=t&&this.hasFloatRenderTargets&&this.hasFloatBlending,this.redraw=()=>{},!this.valid)return;t.disable(t.CULL_FACE),t.disable(t.STENCIL_TEST),t.disable(t.DEPTH_TEST);let i=this;this.resourceLoaded=_RESOURCES.then(()=>{let a=E(t,_RESOURCES.DRAW_RECT_VERT_SRC,t.VERTEX_SHADER),T=E(t,_RESOURCES.DRAW_RECT_UVS_VERT_SRC,t.VERTEX_SHADER),u=E(t,_RESOURCES.DRAW_COL_FRAG_SRC,t.FRAGMENT_SHADER),l=E(t,_RESOURCES.CONST_COL_FRAG_SRC,t.FRAGMENT_SHADER),o=E(t,_RESOURCES.DRAW_LINES_VERT_SRC,t.VERTEX_SHADER),s=E(t,_RESOURCES.DRAW_BBOX_VERT_SRC,t.VERTEX_SHADER),S=E(t,_RESOURCES.DRAW_LIGHTS_BINARY_FRAG_SRC,t.FRAGMENT_SHADER),h=E(t,_RESOURCES.DRAW_LIGHTS_PCF_FRAG_SRC,t.FRAGMENT_SHADER),d=E(t,_RESOURCES.DRAW_LIGHTS_BBOX_VERT_SRC,t.VERTEX_SHADER),A=E(t,_RESOURCES.DRAW_LIGHTS_OBBOX_VERT_SRC,t.VERTEX_SHADER),c=E(t,_RESOURCES.DRAW_OBBOX_VERT_SRC,t.VERTEX_SHADER),L=E(t,_RESOURCES.GEN_BBOX_FRAG_SRC,t.FRAGMENT_SHADER),g=E(t,_RESOURCES.GEN_OBBOX_FRAG_SRC,t.FRAGMENT_SHADER),D=E(t,_RESOURCES.GEN_PLANE_MAP_FRAG_SRC,t.FRAGMENT_SHADER),B=r(t,o,l),U=r(t,T,D),O=r(t,a,L),b=r(t,a,g),f=r(t,d,S),C=r(t,A,S),N=r(t,d,h),F=r(t,A,h),x=r(t,s,u),m=r(t,c,u);B.loc={lines:n(t,B,"lines"),constCol:n(t,B,"constCol")},U.loc={inRectBounds:n(t,U,"inRectBounds"),v1LinesBvh:n(t,U,"v1LinesBvh"),lightingData:n(t,U,"lightingData")},[O,b].forEach(e=>{e.loc={inRectBounds:n(t,e,"inRectBounds"),lightPlaneMap:n(t,e,"lightPlaneMap"),lightingData:n(t,e,"lightingData")}}),[f,C,N,F].forEach(e=>{e.loc={invNumLights:n(t,e,"invNumLights"),lightPlaneMap:n(t,e,"lightPlaneMap"),lightingData:n(t,e,"lightingData")}}),[f,N].forEach(e=>{e.loc.lightBounds=n(t,e,"lightBBox")}),[C,F].forEach(e=>{e.loc.lightBounds=n(t,e,"lightOBBox")}),x.loc={lightBounds:n(t,x,"lightBBox")},m.loc={lightBounds:n(t,m,"lightOBBox")},R(t,a,T,u,l,o,s,S,h,d,A,c,L,g,D);let $=_RESOURCES.NUMBER_FORMATS.r11g11b10,M=(e,t,E,r)=>{let n=new Uint32Array(4),R=new Float32Array(n.buffer);return R[0]=e[0],R[1]=e[1],R[2]=t,n[3]=$(r[0]*E,r[1]*E,r[2]*E),n},X=e=>{let t=new Uint32Array(4*e.length),E=new Float32Array(t.buffer);for(let r=0;r<e.length;++r){let n=e[r];E[4*r+0]=n.position[0],E[4*r+1]=n.position[1],E[4*r+2]=n.decayRate;let R=n.colour,i=n.intensity;t[4*r+3]=$(R[0]*i,R[1]*i,R[2]*i)}return t},_=[],I=Math.random,P=1;for(let G=0;G<128;++G)_.push({position:[.5*I()+.25,.5*I()+.25],decayRate:1+10*I(),intensity:1*I(),colour:[I(),I(),I()]});_[0].intensity=1;let w=(e,E)=>{let r=e.length/4,n=E.length/4,R=n/3,i=t.createTexture();t.bindTexture(t.TEXTURE_2D,i),t.texImage2D(t.TEXTURE_2D,0,t.RGBA32F,n,1,0,t.RGBA,t.FLOAT,E),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST);let a=t.createTexture();return t.bindTexture(t.TEXTURE_2D,a),t.texImage2D(t.TEXTURE_2D,0,t.RGBA32F,r,1,0,t.RGBA,t.FLOAT,e),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST),{numLines:r,numBvhFloat4:n,numBvhEntries:R,bvhTexture:i,linesTexture:a}},p=[w(_RESOURCES.SIMPLE_LINES,_RESOURCES.SIMPLE_LINES_BVH),w(_RESOURCES.MODERATE_LINES,_RESOURCES.MODERATE_LINES_BVH),w(_RESOURCES.COMPLEX_LINES,_RESOURCES.COMPLEX_LINES_BVH)],v=t.createTexture();t.bindTexture(t.TEXTURE_2D,v),t.texImage2D(t.TEXTURE_2D,0,t.RGBA32UI,128,1,0,t.RGBA_INTEGER,t.UNSIGNED_INT,X(_)),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST);let H=()=>{t.bindFramebuffer(t.FRAMEBUFFER,null),t.drawBuffers([t.BACK]),t.viewport(0,0,e.width,e.height)},V=e=>{e.sort((e,t)=>e[0]-t[0]);let t=e.length-1;for(;t>0;--t){let E=e[t],r=e[t-1];r[1]>=E[0]&&(r[1]=Math.max(r[1],E[1]),e.pop(t))}},y=()=>(e.width!==e.clientWidth||e.height!==e.clientHeight)&&(e.width=e.clientWidth,e.height=e.clientHeight,!0),W=()=>{let e=i.currentPlaneMapResolution!=i.newPlaneMapResolution,E=e||i.currentScene!=i.newScene,r=i.currentlyUsingOBbox!=i.newUsingOBbox,n=[],R=[];if(e&&(null!=i.planeMapFb&&(i.planeMapFb.destroy(),i.planeMapFb=null),i.planeMapFb=new TextureFramebuffer(t,t.RGB10_A2,t.RGBA,t.UNSIGNED_INT_2_10_10_10_REV,i.newPlaneMapResolution,128,t.REPEAT,t.CLAMP_TO_EDGE),i.currentPlaneMapResolution=i.newPlaneMapResolution),r&&(null!=i.boundsFb&&(i.boundsFb.destroy(),i.boundsFb=null),i.boundsFb=new TextureFramebuffer(t,i.newUsingOBbox?t.RGBA32UI:t.RGBA32F,i.newUsingOBbox?t.RGBA_INTEGER:t.RGBA,i.newUsingOBbox?t.UNSIGNED_INT:t.FLOAT,128,1,t.CLAMP_TO_EDGE,t.CLAMP_TO_EDGE),i.currentlyUsingOBbox=i.newUsingOBbox),E?(i.currentScene=i.newScene,n.push([0,i.currentNumLightsToRender])):r&&R.push([0,i.currentNumLightsToRender]),i.currentNumLightsToRender!=i.newNumLightsToRender&&(i.newNumLightsToRender>i.currentNumLightsToRender&&n.push([i.currentNumLightsToRender,i.newNumLightsToRender]),i.currentNumLightsToRender=i.newNumLightsToRender),i.dirtyLights.length>0){let a=new Set(i.dirtyLights);t.bindTexture(t.TEXTURE_2D,v),a.forEach(e=>{let E=_[e],r=M(E.position,E.decayRate,E.intensity,E.colour);t.texSubImage2D(t.TEXTURE_2D,0,e,0,1,1,t.RGBA_INTEGER,t.UNSIGNED_INT,r),n.push([e,e+1])}),i.dirtyLights=[]}V(n),n.forEach(e=>{R.push(e)}),V(R),n.length>0&&(t.disable(t.BLEND),i.planeMapFb.bind(()=>{t.useProgram(U),t.activeTexture(t.TEXTURE0),t.bindTexture(t.TEXTURE_2D,p[i.currentScene].bvhTexture),t.uniform1i(U.loc.v1LinesBvh,0),t.activeTexture(t.TEXTURE1),t.bindTexture(t.TEXTURE_2D,v),t.uniform1i(U.loc.lightingData,1);let e=1/i.planeMapFb.height;n.forEach(E=>{t.uniform4f(U.loc.inRectBounds,0,E[0]*e,1,E[1]*e),t.drawArrays(t.TRIANGLES,0,6)})})),R.length>0&&(t.disable(t.BLEND),i.boundsFb.bind(()=>{let e=i.newUsingOBbox?b:O;t.useProgram(e),t.activeTexture(t.TEXTURE0),t.bindTexture(t.TEXTURE_2D,i.planeMapFb.texture),t.uniform1i(e.loc.lightPlaneMap,0),t.activeTexture(t.TEXTURE1),t.bindTexture(t.TEXTURE_2D,v),t.uniform1i(e.loc.lightingData,1);let E=1/i.boundsFb.width;R.forEach(r=>{t.uniform4f(e.loc.inRectBounds,r[0]*E,0,r[1]*E,1),t.drawArrays(t.TRIANGLES,0,6)})})),(y()||n.length>0||R.length>0)&&H(),t.clear(t.COLOR_BUFFER_BIT),t.enable(t.BLEND),t.blendEquation(t.FUNC_ADD),t.blendFunc(t.ONE,t.ONE);{let T=i.currentlyUsingOBbox?i.usePCF?F:C:i.usePCF?N:f;t.useProgram(T),t.activeTexture(t.TEXTURE0),t.bindTexture(t.TEXTURE_2D,i.planeMapFb.texture),t.uniform1i(T.loc.lightPlaneMap,0),t.activeTexture(t.TEXTURE1),t.bindTexture(t.TEXTURE_2D,v),t.uniform1i(T.loc.lightingData,1),t.activeTexture(t.TEXTURE2),t.bindTexture(t.TEXTURE_2D,i.boundsFb.texture),t.uniform1i(T.loc.lightBounds,2),t.uniform1f(T.loc.invNumLights,.0078125),t.drawArrays(t.TRIANGLES,0,6*i.currentNumLightsToRender)}if(i.drawLines&&(t.blendFunc(t.ONE_MINUS_DST_COLOR,t.ONE_MINUS_SRC_ALPHA),t.useProgram(B),t.activeTexture(t.TEXTURE0),t.bindTexture(t.TEXTURE_2D,p[i.currentScene].linesTexture),t.uniform1i(B.loc.lines,0),t.uniform4f(B.loc.constCol,1,1,1,1),t.drawArrays(t.LINES,0,2*p[i.currentScene].numLines)),i.drawBounds){let u=i.currentlyUsingOBbox?m:x;t.enable(t.BLEND),t.blendFunc(t.ONE_MINUS_DST_COLOR,t.ONE_MINUS_SRC_ALPHA),t.useProgram(u),t.activeTexture(t.TEXTURE0),t.bindTexture(t.TEXTURE_2D,i.boundsFb.texture),t.uniform1i(u.loc.lightingData,0),t.drawArrays(t.LINES,0,8*i.currentNumLightsToRender)}};i.maxLights=128,i.lights=_,i.dirtyLights=[],i.currentNumLightsToRender=10,i.newNumLightsToRender=10,i.currentPlaneMapResolution=0,i.newPlaneMapResolution=512,i.planeMapFb=null,i.boundsFb=null,i.currentScene=-1,i.newScene=0,i.currentlyUsingOBbox=!1,i.newUsingOBbox=!0,i.usePCF=!0,i.drawLines=!0,i.drawBounds=!1,i.redraw=W,W()})}}export function bindCircularMappingContext(e){return void 0==e.drawCtx&&(e.drawCtx=new CircularMappingCanvasContext(e)),e.drawCtx}