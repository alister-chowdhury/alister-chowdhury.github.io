import{AsyncBarrier as e,loadCommonShaderSource as t,resolveChildren as i,createCanvasDragHandler as r,loadF32Lines as n}from"../../util.js";import{WebGPUState as a,presentationFormat as o,ImmContext as u,makeGPUBuffer as l,asyncMakeGPUBuffer as p,createShaderModule as s,asyncCreateShaderModule as y,asyncCompleteDesc as b,asyncCreateBindGroupLayout as d,asyncCreatePipelineLayout as g,asyncCreateComputePipeline as f,asyncCreateRenderPipeline as L}from"../../webgpu_util.js";export const RTV2=(()=>{function s(e){return fetch("./shaders/compiled/"+e).then(e=>e.text())}let b=e=>t(e,"webgpu"),$=e=>y(b(e)),m=e=>y(s(e)),c=["pointlight","visibility","num_visits","num_intersections","composite"],w=(()=>{let t={entryPoint:"main",module:$("draw_col.frag.wgsl"),targets:[{format:o},]},r=()=>{let e={},t=e=>`V2_TRACING_BVHGEN__${e}`;e.bg0Layout=d({entries:[{binding:0,visibility:GPUShaderStage.COMPUTE,buffer:{type:"read-only-storage"}},{binding:1,visibility:GPUShaderStage.COMPUTE,buffer:{type:"storage"}},{binding:2,visibility:GPUShaderStage.COMPUTE,buffer:{type:"uniform"}},],label:t("bg0Layout")}),e.pipeLayout=g({bindGroupLayouts:[e.bg0Layout],label:t("pipeLayout")});for(let r=1;r<5;++r)e[`pipelineL${r}`]=f({layout:e.pipeLayout,compute:{entryPoint:"main",module:$(`v2_tracing_generate_bvh_L${r}.comp.wgsl`)}});return i(e)},l=()=>{let e={},r=e=>`DRAWLINES__${e}`;return e.bg0Layout=d({entries:[{binding:0,visibility:GPUShaderStage.VERTEX,buffer:{type:"read-only-storage"}},{binding:1,visibility:GPUShaderStage.VERTEX,buffer:{type:"uniform"}}],label:r("bg0Layout")}),e.pipeLayout=g({bindGroupLayouts:[e.bg0Layout],label:r("pipeLayout")}),e.pipeline=L({layout:e.pipeLayout,vertex:{entryPoint:"main",module:m("draw_lines.vert.wgsl")},fragment:t,primitive:{topology:"line-list"}}),i(e)},s=()=>{let e={},t=e=>`V2TRACING__${e}`;e.bg0Layout=d({entries:[{binding:0,visibility:GPUShaderStage.FRAGMENT,buffer:{type:"read-only-storage"}},{binding:1,visibility:GPUShaderStage.FRAGMENT,buffer:{type:"uniform"}},],label:t("bg0Layout")}),e.pipeLayout=g({bindGroupLayouts:[e.bg0Layout],label:t("pipeLayout")});let r={entryPoint:"main",module:$("draw_full_screen_uvs.vert.wgsl")};return c.forEach(t=>{e[`pipeline_${t}`]=L({layout:e.pipeLayout,vertex:r,fragment:{entryPoint:"main",module:m(`v2_tracing_test_${t}.frag.wgsl`),targets:[{format:o},]},primitive:{topology:"triangle-list"}})}),i(e)},y=()=>{let e={},t=e=>`PICK_LINE_TO_EDIT__${e}`;return e.bg0Layout=d({entries:[{binding:0,visibility:GPUShaderStage.COMPUTE,buffer:{type:"read-only-storage"}},{binding:1,visibility:GPUShaderStage.COMPUTE,buffer:{type:"storage"}},{binding:2,visibility:GPUShaderStage.COMPUTE,buffer:{type:"uniform"}},{binding:3,visibility:GPUShaderStage.COMPUTE,buffer:{type:"uniform"}},],label:t("bg0Layout")}),e.pipeLayout=g({bindGroupLayouts:[e.bg0Layout],label:t("pipeLayout")}),e.pipeline=f({layout:e.pipeLayout,compute:{entryPoint:"main",module:m("pick_line_to_edit.comp.wgsl")}}),i(e)},b=()=>{let e={},t=e=>`APPLY_SNAPPING__${e}`;return e.bg0Layout=d({entries:[{binding:0,visibility:GPUShaderStage.COMPUTE,buffer:{type:"read-only-storage"}},{binding:1,visibility:GPUShaderStage.COMPUTE,buffer:{type:"uniform"}},{binding:2,visibility:GPUShaderStage.COMPUTE,buffer:{type:"uniform"}},{binding:3,visibility:GPUShaderStage.COMPUTE,buffer:{type:"storage"}},],label:t("bg0Layout")}),e.pipeLayout=g({bindGroupLayouts:[e.bg0Layout],label:t("pipeLayout")}),e.pipeline=f({layout:e.pipeLayout,compute:{entryPoint:"main",module:m("apply_snapping.comp.wgsl")}}),i(e)},w=()=>{let e={},t=e=>`APPLY_LINE_EDIT__${e}`;return e.bg0Layout=d({entries:[{binding:0,visibility:GPUShaderStage.COMPUTE,buffer:{type:"storage"}},{binding:1,visibility:GPUShaderStage.COMPUTE,buffer:{type:"uniform"}},{binding:2,visibility:GPUShaderStage.COMPUTE,buffer:{type:"uniform"}},],label:t("bg0Layout")}),e.pipeLayout=g({bindGroupLayouts:[e.bg0Layout],label:t("pipeLayout")}),e.pipeline=f({layout:e.pipeLayout,compute:{entryPoint:"main",module:m("apply_line_edit.comp.wgsl")}}),i(e)},P=()=>{let e={},t=e=>`DRAWEDPTS__${e}`;return e.bg0Layout=d({entries:[{binding:0,visibility:GPUShaderStage.VERTEX,buffer:{type:"read-only-storage"}}],label:t("bg0Layout")}),e.pipeLayout=g({bindGroupLayouts:[e.bg0Layout],label:t("pipeLayout")}),e.pipeline=L({layout:e.pipeLayout,vertex:{entryPoint:"main",module:m("draw_editable_points.vert.wgsl")},fragment:{entryPoint:"main",module:m("draw_editable_points.frag.wgsl"),targets:[{format:o,blend:{color:{srcFactor:"src-alpha",dstFactor:"one-minus-src-alpha"},alpha:{srcFactor:"src-alpha",dstFactor:"one-minus-src-alpha"}}},]},primitive:{topology:"triangle-list"}}),i(e)},v=()=>{let e={},t=e=>`DRAWPICKED__${e}`;return e.bg0Layout=d({entries:[{binding:0,visibility:GPUShaderStage.VERTEX,buffer:{type:"read-only-storage"}},{binding:1,visibility:GPUShaderStage.VERTEX,buffer:{type:"uniform"}}],label:t("bg0Layout")}),e.pipeLayout=g({bindGroupLayouts:[e.bg0Layout],label:t("pipeLayout")}),e.pipeline=L({layout:e.pipeLayout,vertex:{entryPoint:"main",module:m("draw_picked_point.vert.wgsl")},fragment:{entryPoint:"main",module:m("draw_picked_point.frag.wgsl"),targets:[{format:o,blend:{color:{srcFactor:"src-alpha",dstFactor:"one-minus-src-alpha"},alpha:{srcFactor:"src-alpha",dstFactor:"one-minus-src-alpha"}}},]},primitive:{topology:"triangle-list"}}),i(e)},E=()=>{let e={},t=e=>`DRAWTREE__${e}`;return e.bg0Layout=d({entries:[{binding:0,visibility:GPUShaderStage.VERTEX,buffer:{type:"read-only-storage"}},{binding:1,visibility:GPUShaderStage.VERTEX,buffer:{type:"uniform"}}],label:t("bg0Layout")}),e.pipeLayout=g({bindGroupLayouts:[e.bg0Layout],label:t("pipeLayout")}),e.pipeline=L({layout:e.pipeLayout,vertex:{entryPoint:"main",module:m("draw_tree.vert.wgsl")},fragment:{entryPoint:"main",module:m("draw_tree.frag.wgsl"),targets:[{format:o,blend:{color:{srcFactor:"src-alpha",dstFactor:"one-minus-src-alpha"},alpha:{srcFactor:"src-alpha",dstFactor:"one-minus-src-alpha"}}},]},primitive:{topology:"triangle-list"}}),i(e)},_=()=>{new e;let t=e=>{let t=p(GPUBufferUsage.COPY_SRC,e),i=p(GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_DST,e),r=e.then(e=>e.length/4),n=r.then(e=>p(GPUBufferUsage.UNIFORM,new Uint32Array([e]))),a=Promise.all([t,i,e.then(e=>e.byteLength)]).then(([e,t,i])=>r=>{r.copyBufferToBuffer(e,0,t,0,i)});return{data:e,refBuffer:t,buffer:i,numLines:r,numLinesUBO:n,reset:a}},r=e=>t(n(e)),a=r("/res/lines_simple0.f32"),o=r("/res/lines_moderate0.f32"),u=r("/res/lines.f32"),l=t(u.data.then(e=>{let t=new Float32Array(4*e.length);for(let i=0;i<e.length;i+=4){let r=.5*e[i],n=.5*e[i+1],a=.5*e[i+2],o=.5*e[i+3];t[4*i+0]=r,t[4*i+1]=n,t[4*i+2]=a,t[4*i+3]=o,t[(i+1)*4+0]=r+.5,t[(i+1)*4+1]=n,t[(i+1)*4+2]=a+.5,t[(i+1)*4+3]=o,t[(i+2)*4+0]=r+.5,t[(i+2)*4+1]=n+.5,t[(i+2)*4+2]=a+.5,t[(i+2)*4+3]=o+.5,t[(i+3)*4+0]=r,t[(i+3)*4+1]=n+.5,t[(i+3)*4+2]=a,t[(i+3)*4+3]=o+.5}return t}));return i({simple:a,moderate:o,complex:u,veryComplex:l})};return new e().enqueue(a.onready).enqueue(u.onready).enqueue(r(),"v2GenBVH").enqueue(s(),"v2Tracing").enqueue(y(),"pickLineToEdit").enqueue(b(),"applyLineSnapping").enqueue(w(),"applyLineEdit").enqueue(l(),"drawLines").enqueue(P(),"drawEditablePoints").enqueue(v(),"drawPickedPoint").enqueue(E(),"drawTree").enqueue(_(),"lines")})();class P{constructor(e){let t=this;t.redraw=()=>{};let i=a,n=null,p=null;t.onerror=new Promise(e=>{n=e}),t.onready=new Promise(e=>{p=e}),t.hasErrors=!1;let s=e=>{t.hasErrors=!0,t.redraw=()=>{},n(e)},y=e.getContext("webgpu");if(!y){s("Unable to create WebGPU context.");return}i.onerror.then(()=>{s(i.err)}),w.then(()=>{if(!i.ok)return;navigator.gpu;let n=i.device;i.adapter;let a=u,s=w.v2GenBVH,b=w.v2Tracing,d=w.pickLineToEdit,g=w.applyLineSnapping,f=w.applyLineEdit,L=w.lines,$=w.drawLines,m=w.drawEditablePoints,P=w.drawPickedPoint,v=w.drawTree,E=l(GPUBufferUsage.UNIFORM,new Float32Array([0,0,0,0])),_=l(GPUBufferUsage.UNIFORM,new Float32Array([1,1,1,1])),h=!0,T=3,G=null,O=L.complex;l(GPUBufferUsage.UNIFORM,new Uint32Array([4294967295,0]));let R=!1,C=null,U=!1,M=!0,F=1,B=!1,x=2*T-1,I=0,N=0,V=l(GPUBufferUsage.UNIFORM,new Int32Array([N])),A=[.4,.6],S=l(GPUBufferUsage.UNIFORM,new Float32Array(A)),k=S,q=e=>{A[0]==e[0]&&A[1]==e[1]||(A[0]=e[0],A[1]=e[1],S=l(GPUBufferUsage.UNIFORM,new Float32Array(A)),R=!0,U||(k=S))},D=()=>{C=null},W=e=>{R=!0,q(e),U&&(C=n.createBuffer({size:8,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.STORAGE}),a.computePass({},e=>{e.setPipeline(d.pipeline),e.setBindGroup(0,d.bg0Layout.createGroup(O.buffer,C,O.numLinesUBO,S)),e.dispatchWorkgroups(1)})),t.redraw()},X=e=>{q(e),t.redraw()},H=()=>{D(),t.redraw()},Y=()=>{y.configure({device:n,format:o,size:[e.width,e.height]})},z=()=>{(e.width!==e.clientWidth||e.height!==e.clientHeight)&&(e.width=e.clientWidth,e.height=e.clientHeight,Y())},j=()=>{z();let e=R;if(R=!1,e&&U&&C&&(a.computePass({},e=>{let t=S;M&&(t=l(GPUBufferUsage.UNIFORM|GPUBufferUsage.STORAGE,new Float32Array(A)),e.setPipeline(g.pipeline),e.setBindGroup(0,g.bg0Layout.createGroup(O.buffer,C,O.numLinesUBO,t)),e.dispatchWorkgroups(1)),e.setPipeline(f.pipeline),e.setBindGroup(0,f.bg0Layout.createGroup(O.buffer,C,t)),e.dispatchWorkgroups(1)}),h=!0),h){h=!1;let t=1<<T,i=(t*t-1)*3+O.numLines;G=n.createBuffer({size:16*i,usage:GPUBufferUsage.STORAGE}),a.computePass({},e=>{e.setPipeline(s[`pipelineL${T}`]),e.setBindGroup(0,s.bg0Layout.createGroup(O.buffer,G,O.numLinesUBO)),e.dispatchWorkgroups(1)})}let r=y.getCurrentTexture().createView(),o={colorAttachments:[{clearValue:B?{r:1,g:1,b:1,a:1}:{r:0,g:0,b:0,a:1},loadOp:"clear",storeOp:"store",view:r},]};a.renderPass(o,e=>{if(B){let t=2*T-1,i=x<t?x:t,r=I<i?I:i,n=(2<<i)-1<<1,a=(1<<r)-1<<1,o=n-a;N!=a&&(N=a,V=l(GPUBufferUsage.UNIFORM,new Int32Array([N]))),e.setPipeline(v.pipeline),e.setBindGroup(0,v.bg0Layout.createGroup(G,V)),e.draw(6*o)}else e.setPipeline(b[`pipeline_${c[F]}`]),e.setBindGroup(0,b.bg0Layout.createGroup(G,k)),e.draw(3);e.setPipeline($.pipeline),e.setBindGroup(0,$.bg0Layout.createGroup(O.buffer,B?E:_)),e.draw(2*O.numLines),U&&(e.setPipeline(m.pipeline),e.setBindGroup(0,m.bg0Layout.createGroup(O.buffer)),e.draw(12*O.numLines),C&&(e.setPipeline(P.pipeline),e.setBindGroup(0,P.bg0Layout.createGroup(O.buffer,C)),e.draw(12)))}),a.submit()};j(),r(e,W,X,H),t.redraw=()=>{requestAnimationFrame(j)},t.setCurrentLines=e=>{let i=[L.simple,L.moderate,L.complex,L.veryComplex][e%4];i!=O&&(D(),O=i,h=!0,t.redraw())},t.resetLines=()=>{D(),O.reset(a),h=!0,t.redraw()},t.setBVHLevel=e=>{e!=T&&(T=e,h=!0,t.redraw())},t.setCurrentTracingVisType=e=>{F==e||(F=e,B||t.redraw())},t.setEditing=e=>{U!=e&&(U=e,t.redraw())},t.setSnapWhileEditing=e=>{M=e},t.setDrawTree=e=>{e!=B&&(B=e,t.redraw())},t.setDrawTreeLevel=e=>{e!=x&&(x=e,B&&t.redraw())},t.setDrawTreeLevelStart=e=>{e!=I&&(I=e,B&&t.redraw())},p(t)})}}function v(e){return void 0==e.drawCtx&&(e.drawCtx=new P(e)),e.drawCtx}return{bindRTV2Context:v}})();