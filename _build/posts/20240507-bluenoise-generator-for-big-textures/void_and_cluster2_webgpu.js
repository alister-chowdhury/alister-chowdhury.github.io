import{AsyncBarrier as e,loadCommonShaderSource as t,resolveChildren as r,createCanvasDragHandler as i,loadF32Lines as o,addDPIResizeWatcher as l}from"../../util.js";import{WebGPUState as n,presentationFormat as a,ImmContext as u,makeGPUBuffer as s,createBuffer as p,asyncMakeGPUBuffer as f,createShaderModule as d,asyncCreateShaderModule as y,asyncCompleteDesc as g,asyncCreateBindGroupLayout as m,asyncCreatePipelineLayout as b,asyncCreateComputePipeline as $,asyncCreateRenderPipeline as c,queueSyncPoint as w}from"../../webgpu_util.js";export const VAC2=(()=>{let i=[8,16,32];function o(e){return fetch("./shaders/compiled/"+e).then(e=>e.text())}let f=e=>t(e,"webgpu"),d=e=>y(f(e)),g=e=>y(o(e)),_=(()=>{let t=()=>{let e=e=>`PICK__${e}`,t={};return t.bg0Layout=m({entries:[{binding:0,visibility:GPUShaderStage.COMPUTE,buffer:{type:"uniform"}},{binding:1,visibility:GPUShaderStage.COMPUTE,buffer:{type:"read-only-storage"}},{binding:2,visibility:GPUShaderStage.COMPUTE,buffer:{type:"storage"}},{binding:3,visibility:GPUShaderStage.COMPUTE,buffer:{type:"storage"}},],label:e("bg0Layout")}),t.pipeLayout=b({bindGroupLayouts:[t.bg0Layout],label:e("pipeLayout")}),i.forEach(e=>{t[e]=$({layout:t.pipeLayout,compute:{entryPoint:"main",module:g(`pick_${e}.comp.wgsl`)}})}),r(t)},o=()=>{let e=e=>`UPDATE_ENERGY__${e}`,t={};return t.bg0Layout=m({entries:[{binding:0,visibility:GPUShaderStage.COMPUTE,buffer:{type:"uniform"}},{binding:1,visibility:GPUShaderStage.COMPUTE,buffer:{type:"storage"}},{binding:2,visibility:GPUShaderStage.COMPUTE,buffer:{type:"read-only-storage"}}],label:e("bg0Layout")}),t.pipeLayout=b({bindGroupLayouts:[t.bg0Layout],label:e("pipeLayout")}),i.forEach(e=>{t[e]=$({layout:t.pipeLayout,compute:{entryPoint:"main",module:g(`update_energy_${e}.comp.wgsl`)}})}),r(t)},l=()=>{let e=e=>`BUFFER_TO_IMAGE__${e}`,t={};t.bg0Layout=m({entries:[{binding:0,visibility:GPUShaderStage.FRAGMENT,buffer:{type:"uniform"}},{binding:1,visibility:GPUShaderStage.FRAGMENT,buffer:{type:"read-only-storage"}}],label:e("bg0Layout")}),t.pipeLayout=b({bindGroupLayouts:[t.bg0Layout],label:e("pipeLayout")});let o={entryPoint:"main",module:d("draw_full_screen.vert.wgsl")};return i.forEach(e=>{t[e]={},["r32float","r16float","r8unorm"].forEach(r=>{t[e][r]=c({layout:t.pipeLayout,vertex:o,fragment:{entryPoint:"main",module:g(`buffer_to_image_${e}.frag.wgsl`),targets:[{format:r},]},primitive:{topology:"triangle-list"}})})}),r(t)},s=()=>{let e=e=>`VIS_BLUENOISE__${e}`,t={};t.bg0Layout=m({entries:[{binding:0,visibility:GPUShaderStage.FRAGMENT,buffer:{type:"uniform"}},{binding:1,visibility:GPUShaderStage.FRAGMENT,texture:{sampleType:"unfilterable-float"}}],label:e("bg0Layout")}),t.pipeLayout=b({bindGroupLayouts:[t.bg0Layout],label:e("pipeLayout")});let i={entryPoint:"main",module:d("draw_full_screen_uvs.vert.wgsl")};return t.tiledPipeline=c({layout:t.pipeLayout,vertex:i,fragment:{entryPoint:"main",module:g("vis_bluenoise_tiled.frag.wgsl"),targets:[{format:a},]},primitive:{topology:"triangle-list"}}),t.scaledPipeline=c({layout:t.pipeLayout,vertex:i,fragment:{entryPoint:"main",module:g("vis_bluenoise_scaled.frag.wgsl"),targets:[{format:a},]},primitive:{topology:"triangle-list"}}),r(t)},p=()=>{let e=e=>`BC4COMPRESS__${e}`,t={};return t.bg0Layout=m({entries:[{binding:0,visibility:GPUShaderStage.FRAGMENT,texture:{sampleType:"unfilterable-float"}}],label:e("bg0Layout")}),t.pipeLayout=b({bindGroupLayouts:[t.bg0Layout],label:e("pipeLayout")}),t.pipeline=c({layout:t.pipeLayout,vertex:{entryPoint:"main",module:d("draw_full_screen.vert.wgsl")},fragment:{entryPoint:"main",module:g("bc4_compress.frag.wgsl"),targets:[{format:"rg32uint"},]},primitive:{topology:"triangle-list"}}),r(t)},f=n.onready.then(e=>{let t=n.device.limits,r=t.maxTextureDimension2D,o=t.maxComputeWorkgroupsPerDimension,l=Math.min(t.maxBufferSize,t.maxStorageBufferBindingSize),a={};return i.forEach(e=>{let t=2*Math.floor(r/(4*e)),i=2*Math.floor(r/(2*e)),n=2*Math.floor(Math.sqrt(l/4)/(2*e));a[e]={prefMax:Math.min(t,n),trueMax:Math.min(i,Math.min(o,n))}}),a});return new e().enqueue(n.onready).enqueue(u.onready).enqueue(t(),"pick").enqueue(o(),"updateEnergy").enqueue(l(),"bufferToImage").enqueue(s(),"visBlueNoise").enqueue(p(),"bc4Compress").enqueue(f,"limits")})();class E{constructor(e){let t=this;t.redraw=()=>{};let r=null,i=null;t.onerror=new Promise(e=>{r=e}),t.onready=new Promise(e=>{i=e}),t.hasErrors=!1;let o=e=>{t.hasErrors=!0,t.redraw=()=>{},r(e)},f=e.getContext("webgpu");if(!f){o("Unable to create WebGPU context.");return}l(e);let d=n;d.onerror.then(()=>{o(d.err)}),_.then(()=>{if(!d.ok)return;navigator.gpu;let r=d.device;d.adapter;let o=u,l=4,y=4,g=16,m=1.9,b=Math.pow(m,-2)*Math.LOG2E,$=0,c=!0;t.getIteration=()=>$,t.getInitialState=()=>({numTilesX:l,numTilesY:y,tileSize:g,sigma:m}),t.setNumTilesX=e=>{e!=l&&(l=e,$=0)},t.setNumTilesY=e=>{e!=y&&(y=e,$=0)},t.setTileSize=e=>{e!=g&&(g=e,$=0)},t.setSigma=e=>{e!=m&&(b=Math.pow(m=e,-2)*Math.LOG2E,$=0)},t.setVisTiled=e=>{c=e},t.reset=()=>{$=0},t.getProgress=()=>$/(g*g*4),t.isDone=()=>$==g*g*4;let E=()=>{f.configure({device:r,format:a,size:[e.width,e.height]})},T=()=>{(e.width!==e.dpiWidth||e.height!==e.dpiHeight)&&(e.width=e.dpiWidth,e.height=e.dpiHeight,E())};t.limits=_.limits;let P=_.pick,L=_.updateEnergy,v=_.bufferToImage,R=_.bc4Compress,h=_.visBlueNoise,G=(()=>{let e=0,t=0;return()=>{let r=performance.now(),i=e;e=r;let o=r-i;return t=0==$?Math.max(1,Math.min(1024,Math.floor(64/(g*g)*65536/(l*y))-3)):o>=34?Math.max(1,t-1):Math.min(1024,t+1),t=Math.min(g*g*4-$,t)}})(),x=null,C=null,O=null,A=null,M=null,N=null,S=()=>Math.floor(2147483647*Math.random()),B=[w(),w()],U=0,D=()=>{if(0==$){if(!B[0].ready()||!B[1].ready())return;let e=l*y*16,t=l*g*y*g*4;null!=x&&x.destroy(),null!=C&&C.destroy(),null!=O&&O.destroy(),null!=A&&A.destroy(),null!=M&&M.destroy(),null!=N&&N.destroy(),x=p(GPUBufferUsage.STORAGE,e),C=p(GPUBufferUsage.STORAGE,t),O=p(GPUBufferUsage.STORAGE,t),A=s(GPUBufferUsage.UNIFORM,new Int32Array([l,y,0,0])),M=n.device.createTexture({dimension:"2d",format:"r8unorm",size:[l*g,y*g],usage:GPUTextureUsage.RENDER_ATTACHMENT|GPUTextureUsage.TEXTURE_BINDING}),N=s(GPUBufferUsage.UNIFORM,new Float32Array([l*g,y*g,1/(l*g),1/(y*g)]))}let r=L[g],i=P[g],a=v[g].r8unorm,u=[Math.floor(l*g/16),Math.floor(y*g/16)],f=[Math.floor(l/2),Math.floor(y/2)],d=G(),m=1/(g*g-1),c=(e,t)=>{let r=1-e*m,i=new Float32Array([0,0,0,0,0,0,0,0]),o=new Uint32Array(i.buffer,i.byteOffset);return o[0]=[0,1,1,0][t],o[1]=[0,1,0,1][t],o[2]=l,o[3]=y,i[4]=b,i[5]=r,o[6]=S(),s(GPUBufferUsage.UNIFORM,i)},w=e=>{o.computePass({},t=>{t.setPipeline(r),t.setBindGroup(0,L.bg0Layout.createGroup(e,C,x)),t.dispatchWorkgroups(u[0],u[1])}),o.computePass({},t=>{t.setPipeline(i),t.setBindGroup(0,P.bg0Layout.createGroup(e,C,O,x)),t.dispatchWorkgroups(f[0],f[1])})},_=$+d;for(;$<_;++$){let E=$>>2,T=3&$;w(c(E,T))}let R={colorAttachments:[{clearValue:{r:0,g:0,b:0,a:1},loadOp:"clear",storeOp:"store",view:M.createView()},]};o.renderPass(R,e=>{e.setPipeline(a),e.setBindGroup(0,v.bg0Layout.createGroup(A,O)),e.draw(3)})};t.redraw=()=>{if(!B[U].ready())return;T();let e=f.getCurrentTexture().createView(),r={colorAttachments:[{clearValue:{r:0,g:0,b:0,a:1},loadOp:"clear",storeOp:"store",view:e},]};t.isDone()||D(),o.renderPass(r,e=>{let t=null;t=c?h.tiledPipeline:h.scaledPipeline,e.setPipeline(t),e.setBindGroup(0,h.bg0Layout.createGroup(N,M.createView())),e.draw(3)}),o.submit(),B[U]=w(),U^=1};let I=(e,t)=>{let r=[l*g,y*g],i=n.device.createTexture({dimension:"2d",format:e,size:r,usage:t|GPUTextureUsage.RENDER_ATTACHMENT}),a={colorAttachments:[{clearValue:{r:0,g:0,b:0,a:1},loadOp:"clear",storeOp:"store",view:i.createView()},]};return o.renderPass(a,t=>{let r=v[g][e];t.setPipeline(r),t.setBindGroup(0,v.bg0Layout.createGroup(A,O)),t.draw(3)}),i};t.getBlueNoiseRaw=e=>{let t=I(e,GPUTextureUsage.COPY_SRC),r=[l*g,y*g],i={r32float:4,r16float:2,r8unorm:1}[e],n=Math.floor(256/i),a=(r[0]-1|n-1)+1,u=a!=r[0],s=p(GPUBufferUsage.COPY_DST|GPUBufferUsage.MAP_READ,a*r[1]*i);return o.copyTextureToBuffer({texture:t},{buffer:s,bytesPerRow:i*a},[r[0],r[1]]),o.submit(),s.mapAsync(GPUMapMode.READ).then((i,o,l)=>{let n=s.getMappedRange(),p={r32float:Float32Array,r16float:Uint16Array,r8unorm:Uint8Array}[e],f=new p(a*r[1]);if(f.set(new p(n)),s.unmap(),s.destroy(),t.destroy(),u){let d=new p(r[0]*r[1]),y=a,g=r[0];for(let m=0;m<r[1];++m){let b=y*m,$=g*m;d.set(f.slice(b,b+r[0]),$)}f=d}return[f,r[0],r[1]]})},t.getBc4Compressed=()=>{let e=I("r32float",GPUTextureUsage.TEXTURE_BINDING),t=[Math.floor(l*g/4),Math.floor(y*g/4)],r=n.device.createTexture({dimension:"2d",format:"rg32uint",size:t,usage:GPUTextureUsage.RENDER_ATTACHMENT|GPUTextureUsage.COPY_SRC}),i={colorAttachments:[{clearValue:{r:0,g:0,b:0,a:1},loadOp:"clear",storeOp:"store",view:r.createView()},]};o.renderPass(i,t=>{t.setPipeline(R.pipeline),t.setBindGroup(0,R.bg0Layout.createGroup(e.createView())),t.draw(3)});let a=Math.floor(32),u=(t[0]-1|a-1)+1,s=u!=t[0],f=p(GPUBufferUsage.COPY_DST|GPUBufferUsage.MAP_READ,u*t[1]*8);return o.copyTextureToBuffer({texture:r},{buffer:f,bytesPerRow:8*u},[t[0],t[1]]),o.submit(),f.mapAsync(GPUMapMode.READ).then((i,o,l)=>{let n=f.getMappedRange(),a=new Uint32Array(2*u*t[1]);if(a.set(new Uint32Array(n)),f.unmap(),f.destroy(),e.destroy(),r.destroy(),s){let p=new Uint32Array(t[0]*t[1]*2),d=2*u,y=2*t[0];for(let g=0;g<t[1];++g){let m=d*g,b=y*g;p.set(a.slice(m,m+2*t[0]),b)}a=p}return a})},E(),i(t)})}}function T(e){return void 0==e.drawCtx&&(e.drawCtx=new E(e)),e.drawCtx}return{bindVAC2Context:T,WebGPUState:n,_RESOURCES:_}})();