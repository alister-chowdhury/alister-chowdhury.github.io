<!DOCTYPE html><html lang=en><head><meta charset=utf-8><meta name=author content="Alister Chowdhury"><meta name=theme-color content=#2b2b2b><link href=/css.css rel=stylesheet><meta property=og:site_name content="Stuff And Also Things"><meta name=viewport content="width=device-width, initial-scale=1"><link rel=icon type=image/png sizes=32x32 href=/res/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/res/favicon-16x16.png><script async src="https://www.googletagmanager.com/gtag/js?id=G-1WDZZ2C662"></script><script>if(window.dataLayer=window.dataLayer||[],"alister-chowdhury.github.io"==window.location.hostname){function a(){dataLayer.push(arguments)}a("js",new Date),a("config","G-1WDZZ2C662")}</script><link rel=canonical href=https://alister-chowdhury.github.io/posts/20240507-bluenoise-generator-for-big-textures/><meta property=og:title content="Bluenoise Generator For Bigger Textures"><meta property=og:url content=https://alister-chowdhury.github.io/posts/20240507-bluenoise-generator-for-big-textures/><meta property=og:type content=article><meta property=og:description content="WEBGPU Bluenoise generator for bigger textures, using a tiled void and cluster variant."><meta property=og:image content=https://alister-chowdhury.github.io/res/favicon.png><meta property=og:article:published_time content=2024-05-07T00:00:00><meta property=og:article:tag content=bluenoise><meta property=og:article:tag content="void and cluster"><meta property=og:article:tag content=rendering><meta property=og:article:tag content=dithering><meta property=og:article:tag content="low discrepancy sequence"><script data-rh=true type=application/ld+json>{"@context":"http://schema.org","@type":"Article","author":[{"@type":"Person","name":"By Alister Chowdhury"}],"name":"Bluenoise Generator For Bigger Textures","url":"https://alister-chowdhury.github.io/posts/20240507-bluenoise-generator-for-big-textures/","description":"WEBGPU Bluenoise generator for bigger textures, using a tiled void and cluster variant.","thumbnailUrl":"https://alister-chowdhury.github.io/res/favicon.png","datePublished":"2024-05-07T00:00:00"}</script><title>Bluenoise Generator For Bigger Textures</title><meta name=description content="WEBGPU Bluenoise generator for bigger textures, using a tiled void and cluster variant."><meta name=keywords content="bluenoise, void and cluster, rendering, dithering, low discrepancy sequence"><style>.tileVis{width:150px;height:150px}.bndft>div>div{display:flex;flex-direction:row;flex-wrap:wrap}.s256{width:256px;height:256px}.m512{width:min(100%,512px)}.m512>img{width:min(100%,512px);aspect-ratio:1/1}#viewportWrapper{width:50%;height:50%;position:relative;min-width:64px;min-height:64px;margin-left:auto;margin-right:auto}#viewportResizer{cursor:se-resize;right:2px;bottom:2px;width:20px;height:20px;background:url(/res/resize.svg),#d3d3d3;position:absolute}#viewportFullscreen{cursor:pointer;right:26px;bottom:2px;width:20px;height:20px;background:url(/res/fullscreen.svg),#d3d3d3;position:absolute}#bluenoiseViewport{width:100%;height:100%;margin:0;padding:0}#progressWrapper{display:block;position:relative;width:100%;margin-top:5px;background-color:#d3d3d3;margin-left:auto;margin-right:auto}#progressBar{width:0;height:1.2em;border:0;background-color:#3c3c3c}#progressPercent{position:absolute;display:inline-block;text-align:center;color:#fff;font-weight:bold;mix-blend-mode:difference;padding:0;margin:0}#controls{text-align:center;margin-left:auto;margin-right:auto;width:min-content}#controlsTable{margin-left:auto;margin-right:auto;white-space:nowrap}#controlsTable input[type="number"]{width:5em}#controlsTable input[type="number"]:last-of-type{background:transparent;border:0;color:inherit}#controlsButtons{display:flex;flex-wrap:wrap;justify-content:center;flex-direction:column}</style><script>function addAfterLoaded(e){window.resourcesReady?e():window.afterLoaded.push(e)}window.resourcesReady=!1,window.afterLoaded=[];</script><script type=module>import{VAC2 as e}from"./void_and_cluster2_webgpu.js";window.bindVAC2Context=e.bindVAC2Context,window.WebGPUState=e.WebGPUState,window.resourcesReady=!0,window.afterLoaded.forEach(e=>{e()}),window._RESOURCES=e._RESOURCES;</script></head><body> <div id=header> <a href=/>Home</a> <a href=/posts/>Posts</a> <a href=https://github.com/alister-chowdhury>Github</a> </div> <div id=supportedBrowser> <div id=viewportWrapper> <canvas id=bluenoiseViewport></canvas> <div id=viewportFullscreen title=Fullscreen></div> <div id=viewportResizer title="Resize viewport"></div> </div> <div id=controls> <div id=progressWrapper> <span id=progressPercent></span> <div id=progressBar></div> </div> <table id=controlsTable> <tr> <td id=visTiledLabel>Visualise Tiled</td> <td><input aria-labelledby=visTiledLabel id=visTiled disabled type=checkbox checked></td> </tr> <tr> <td id=sigmaLabel>Sigma</td> <td> <input aria-labelledby=sigmaLabel id=sigmaSlider disabled type=range> <input aria-labelledby=sigmaLabel id=sigmaValue disabled type=number> <input aria-labelledby=sigmaLabel disabled type=number> </td> </tr> <tr> <td>Tile Size</td> <td> <input disabled type=radio id=tileSizeCtrl-8 name=tileSizeCtrl checked=checked><label for=tileSizeCtrl-8>8</label> <input checked=checked disabled type=radio id=tileSizeCtrl-16 name=tileSizeCtrl><label for=tileSizeCtrl-16>16</label> <input disabled type=radio id=tileSizeCtrl-32 name=tileSizeCtrl><label for=tileSizeCtrl-32>32</label> </td> </tr> <tr> <td id=widthTilesLabel>Width</td> <td class> <input aria-labelledby=widthTilesLabel id=widthTilesSlider disabled type=range> <input aria-labelledby=widthTilesLabel id=widthTilesValue disabled type=number> <input aria-labelledby=widthTilesLabel id=widthTilesValueResolved disabled type=number> </td> </tr> <tr> <td id=heightTilesLabel>Height</td> <td class> <input aria-labelledby=heightTilesLabel id=heightTilesSlider disabled type=range> <input aria-labelledby=heightTilesLabel id=heightTilesValue disabled type=number> <input aria-labelledby=heightTilesLabel id=heightTilesValueResolved disabled type=number> </td> </tr> </table> <br> <div id=controlsButtons> <input type=button id=newBlueNoise value="Generate New Bluenoise" disabled> <input type=button id=savePng value="Save (PNG)" disabled> <input type=button id=saveBC4 value="Save (BC4 compressed)" disabled> </div> </div> </div> <div id=notSupportedBrowser></div> <br> <main> <h1>Bluenoise Generator For Bigger Textures</h1> <h2>Background</h2> <p>A while back I wrote a <a href=/posts/20221230-bluenoise-generator/ target=_blank>Bluenoise Generator</a> using WEBGL2, which works reasonably well and was only ever intended to be used for small-ish textures, say 64x64.</p> <p>That said, trying to generate bigger textures (say 1024x1024) and you'd be waiting for minutes.</p> <p>Practically this is fine, you don't typically attempt to generate bluenoise at runtime, normally offsetting the texture read by some multiple of the golden ratio each frame. Even if you did, something like 64x64 is probably a reasonable enough size, assuming it tiles.</p> <p>Theoretically, this isn't very satisfying.</p> <h2>Why Is It Slow?</h2> <p>The reason the previous generator is slow, is simply because there are as many iterations as there are pixels on the final image.</p> <p>With each iteration having to:</p> <ul> <li>Process the entire image, to find the smallest value.</li> <li>Update the energy value of the surrounding pixels.</li> </ul> <p>Even though what happens in an iteration makes use of GPU parallelization, the iterations themselves do not.</p> <p>Meaning the amount of actual dispatched commands becomes:</p> <pre><code>    numDispatchesPerPass = (
          1 // find void
        + numReductionPasses // ceil((log2(max(width, height)) / log2(8))
        + 1 // update energy + pixel value
    )

    numDispatchesTotal = width * height * numDispatchesPerPass
</code></pre> <p>As a result, if you want to fill a 1024x1024 image, you would need to dispatch 6291456 (1024 * 1024 * 6) commands.</p> <p>No wonder it takes so long.</p> <h2>How Can We Speed It Up?</h2> <p>If you've read the previous write up I did, you'll have noticed that quite a lot of it revolves around &quot;how much updating can I get away with not doing&quot;.</p> <p>In case you haven't, if we have a σ around the 1.9 mark, then realistically we should only have to worry about the surrounding 8x8 to get a reasonably artefact free result.</p> <p>Additionally, it's pretty likely the final texture format you'd end up using is either going to be BC4, R8 or R16/R16f (if you're feeling fancy), making full precision is somewhat redundant.</p> <p>You probably see where this is heading, we're going to dice up the texture into tiles and update each tile per iteration.</p> <h2>Tiling</h2> <p>We can't simply evaluate every tile in parallel, we need process them in such a way that they can take their neighbouring tiles into account.</p> <p>Easily done with a 4x4 pattern, (also the reason why the number of tiles have be multiple of 2, could be made to work with odd numbers, but honestly I couldn't be bothered).</p> <div class=imTable> <div><canvas class=tileVis id=tileV00></canvas><br>[0, 0]</div> <div><canvas class=tileVis id=tileV11></canvas><br>[1, 1]</div> <div><canvas class=tileVis id=tileV10></canvas><br>[1, 0]</div> <div><canvas class=tileVis id=tileV01></canvas><br>[0, 1]</div> </div> <p>As such the number of iterations is the number of pixels within a tile, two shaders execute per iteration (pick and update), meaning the total number of dispatchs is <code>2 * 4 * tileSize * tileSize</code>, which is constant regardless of final resolution.</p> <table> <thead> <tr> <th style=text-align:center>Tile Size</th> <th style=text-align:center>Dispatch Count</th> <th style=text-align:center>Unique Values</th> </tr> </thead> <tbody> <tr> <td style=text-align:center>8</td> <td style=text-align:center>512</td> <td style=text-align:center>64</td> </tr> <tr> <td style=text-align:center>16</td> <td style=text-align:center>2048</td> <td style=text-align:center>256</td> </tr> <tr> <td style=text-align:center>32</td> <td style=text-align:center>8192</td> <td style=text-align:center>1024</td> </tr> </tbody> </table> <br> <br> <p>A quick look at the generated bluenoise and corresponding DFT, things generally look fine (σ=1.9).</p> <div class="imTable bndft"> <div><div><div><img class="fixupDPI s256" alt=bn_8_256x256_0_v src=res/bn_8_256x256_0_v.png></div><div><img class="fixupDPI s256" alt=bn_8_256x256_0_d src=res/bn_8_256x256_0_d.png></div></div>tile size: 8</div> <div><div><div><img class="fixupDPI s256" alt=bn_16_256x256_0_v src=res/bn_16_256x256_0_v.png></div><div><img class="fixupDPI s256" alt=bn_16_256x256_0_d src=res/bn_16_256x256_0_d.png></div></div>tile size: 16</div> <div><div><div><img class="fixupDPI s256" alt=bn_32_256x256_0_v src=res/bn_32_256x256_0_v.png></div><div><img class="fixupDPI s256" alt=bn_32_256x256_0_d src=res/bn_32_256x256_0_d.png></div></div>tile size: 32</div> </div> <br> <br> <p>However it is worth mentioning, there are patterns that present themselves when you look a little deeper. This is the result of averaging 128 512x512 blue noise textures (again with σ=1.9), at different tile sizes:</p> <div class=imTable> <div class=m512><img alt=tilesize_8_average_dft src=res/tilesize_8_average_dft.png><br>tile size: 8</div> <div class=m512><img alt=tilesize_16_average_dft src=res/tilesize_16_average_dft.png><br>tile size: 16</div> <div class=m512><img alt=tilesize_32_average_dft src=res/tilesize_32_average_dft.png><br>tile size: 32</div> </div> <br> <p>I'm not sure if this actually matters, but seemed worth putting out there as an observation.</p> <p>Here are all the relevant source code files:</p> <ul> <li>Update Energy (GLSL): <a target=_blank href=https://github.com/alister-chowdhury/alister-chowdhury.github.io/blob/master/_source/posts/20240507-bluenoise-generator-for-big-textures/shaders/update_energy.comp>update_energy.comp</a></li> <li>Pick Tile Cell (GLSL): <a target=_blank href=https://github.com/alister-chowdhury/alister-chowdhury.github.io/blob/master/_source/posts/20240507-bluenoise-generator-for-big-textures/shaders/pick.comp>pick.comp</a></li> <li>Helpers (GLSL): <a target=_blank href=https://github.com/alister-chowdhury/alister-chowdhury.github.io/blob/master/_source/posts/20240507-bluenoise-generator-for-big-textures/shaders/bn2common.glsli>bn2common.glsli</a></li> <li>JS used for demo: <a target=_blank href=https://github.com/alister-chowdhury/alister-chowdhury.github.io/blob/master/_source/posts/20240507-bluenoise-generator-for-big-textures/void_and_cluster2_webgpu.js>void_and_cluster2_webgpu.js</a></li> </ul> </main> <script>document.querySelectorAll(".fixupDPI").forEach(e=>{let t=e.clientWidth,l=e.clientHeight,n=null;(n=new ResizeObserver(i=>{let o=i[0],r,a;o.devicePixelContentBoxSize?(r=o.devicePixelContentBoxSize[0].inlineSize,a=o.devicePixelContentBoxSize[0].blockSize):o.contentBoxSize&&(r=Math.round(o.contentBoxSize[0].inlineSize*devicePixelRatio),a=Math.round(o.contentBoxSize[0].blockSize*devicePixelRatio)),e.width=t,e.height=l,e.style.width=`${t*t/r}px`,e.style.height=`${l*l/a}px`,n.disconnect()})).observe(e)}),[0,1].forEach(e=>{[0,1].forEach(t=>{let l=37.5,n=document.getElementById("tileV"+e+t);n.width=150,n.height=150;let i=n.getContext("2d");i.clearRect(0,0,150,150),i.rect(0,0,150,150),i.fillStyle="#400778",i.fill(),i.stroke(),i.fillStyle="#dfffff";for(let o=e;o<4;o+=2)for(let r=t;r<4;r+=2)i.beginPath(),i.rect(37.5*o,37.5*r,37.5,37.5),i.fill();i.beginPath(),i.strokeStyle="#1d1d1d";for(let a=1;a<4;++a)i.moveTo(37.5*a,0),i.lineTo(37.5*a,150),i.moveTo(0,37.5*a),i.lineTo(150,37.5*a);i.stroke(),i.beginPath(),i.strokeStyle="#d500ff";let d=(e,t,l,n)=>{i.moveTo(e,t),i.lineTo(l,n);let o=Math.atan2(n-t,l-e),r=Math.PI/5,a=l-4*Math.cos(o-r),d=n-4*Math.sin(o-r);i.lineTo(a,d);let s=l-4*Math.cos(o+r),u=n-4*Math.sin(o+r);i.lineTo(s,u),i.lineTo(l,n)};for(let s=e;s<4;s+=2)for(let u=t;u<4;u+=2){let c=(s+.5)*37.5,m=(u+.5)*37.5;for(let g=-1;g<=1;++g)for(let p=-1;p<=1;++p){if(0==g&&0==p)continue;let h=1/Math.sqrt(g*g+p*p),_=c+h*g*31.875,$=m+h*p*31.875,y=c+h*g*9.375,f=m+h*p*9.375;d(_,$,y,f)}}i.stroke()})}),addAfterLoaded(()=>{let e=document.getElementById("bluenoiseViewport"),t=window.bindVAC2Context(e);t.onerror.then(t=>{e.style.display="none",document.getElementById("supportedBrowser").style.display="none";var l=document.getElementById("notSupportedBrowser");l.style.display="block",l.innerHTML=` Sorry, this demo won't work on your browser.<br> Reason: <strong>${t}</strong><br>`}),t.onready.then(()=>{let l=(e,t,l)=>{let n=[],i=[!1],o=[0],r=(e,t)=>{if(i[0])return;i[0]=!0;let r=1*e.value,a=l(r);for(let d of(a!=r&&(e.value=a),o[0]=a,t.value=a,n))d(a);i[0]=!1},a=()=>{r(e,t)},d=()=>{r(t,e)};e.oninput=a,e.onchange=a,t.onchange=d;let s=null,u=l=>{for(let r of(i[0]=!0,o[0]=l,e.value=l,t.value=l,n))r(l);return i[0]=!1,s};return s={set:u,get:()=>o[0],enable(){e.disabled=!1,t.disabled=!1},addCallback:e=>(n.push(e),s)}},n=t.getInitialState(),i=(()=>{let e=[],t=[n.tileSize],l=document.querySelectorAll("[id^=tileSizeCtrl]"),i=e=>{let t=e.split("-");return 1*t[t.length-1]};l.forEach(l=>{let n=i(l.id);l.onchange=()=>{for(let l of(t[0]=n,e))l(n)}});let o=null;return o={get:()=>t[0],enable(){l.forEach(e=>{e.disabled=!1})},addCallback:t=>(e.push(t),o)}})(),o=document.getElementById("sigmaSlider"),r=document.getElementById("sigmaValue");o.min=1,o.max=3,o.step=.01,r.step=.1;let a=l(o,r,e=>e).set(n.sigma),d=document.getElementById("widthTilesSlider"),s=document.getElementById("widthTilesValue"),u=document.getElementById("widthTilesValueResolved"),c=document.getElementById("heightTilesSlider"),m=document.getElementById("heightTilesValue"),g=document.getElementById("heightTilesValueResolved"),p=t.limits,h=e=>{if(1&e&&(e^=1),e<2)return 2;let t=p[i.get()].trueMax;return e>t?t:e};d.min=2,d.max=p[16].prefMax,d.step=2,s.min=2,s.max=p[16].trueMax,s.step=2,c.min=2,c.max=p[16].prefMax,c.step=2,m.min=2,m.max=p[16].trueMax,m.step=2;let _=l(d,s,h).addCallback(e=>{let t=i.get();u.value=e*t}).set(n.numTilesX),$=l(c,m,h).addCallback(e=>{let t=i.get();g.value=e*t}).set(n.numTilesY);i.addCallback(e=>{_.set(h(_.get())),$.set(h($.get())),d.max=p[e].prefMax,s.max=p[e].trueMax,c.max=p[e].prefMax,m.max=p[e].trueMax,u.value=_.get()*e,g.value=$.get()*e});let y=document.getElementById("visTiled");y.disabled=!1,y.onchange=()=>{t.setVisTiled(y.checked)},_.addCallback(e=>t.setNumTilesX(e)),$.addCallback(e=>t.setNumTilesY(e)),i.addCallback(e=>t.setTileSize(e)),a.addCallback(e=>t.setSigma(e)),_.enable(),$.enable(),i.enable(),a.enable();let f=document.getElementById("newBlueNoise");function v(e){e.preventDefault(),"mousedown"==e.type?(document.documentElement.addEventListener("mousemove",E,!1),document.documentElement.addEventListener("mouseup",b,!1)):(document.documentElement.addEventListener("touchmove",E,!1),document.documentElement.addEventListener("touchend",b,!1))}function E(e){e.preventDefault();var t=document.getElementById("viewportWrapper");let l=t.getBoundingClientRect();document.getElementById("viewportResizer");var n="mousemove"==e.type?e.clientX:e.touches[0].clientX,i="mousemove"==e.type?e.clientY:e.touches[0].clientY;t.style.width=`${Math.max(1,Math.round(n-l.x+11))}px`,t.style.height=`${Math.max(1,Math.round(i-l.y+11))}px`}function b(e){e.preventDefault(),"mouseup"==e.type?(document.documentElement.removeEventListener("mousemove",E,!1),document.documentElement.removeEventListener("mouseup",b,!1)):(document.documentElement.removeEventListener("touchmove",E,!1),document.documentElement.removeEventListener("touchend",b,!1))}function x(){var e=document.getElementById("viewportWrapper");let t=e.getBoundingClientRect();e.style.width=`${Math.max(1,Math.round(t.width))}px`,e.style.height=`${Math.max(1,Math.round(t.height))}px`;var l=document.getElementById("viewportResizer");l.addEventListener("mousedown",v,!1),l.addEventListener("touchstart",v,!1)}f.disabled=!1,f.onclick=()=>{t.reset()},document.getElementById("viewportFullscreen").onclick=()=>{e.requestFullscreen()},x();let B=null,w=document.getElementById("savePng"),I=document.getElementById("saveBC4"),S=[f,w,I,o,r,d,s,c,m,];document.querySelectorAll("[id^=tileSizeCtrl]").forEach(e=>{S.push(e)});let k=()=>{S.forEach(e=>{e.prevDisabled=e.disabled,e.disabled=!0})},T=()=>{S.forEach(e=>{e.disabled=e.prevDisabled})},C=!1;w.onclick=()=>{k();let e=t.getBlueNoiseRaw("r8unorm"),l=()=>{e.then(e=>{let t=e[0],l=e[1],n=e[2],i=UPNG.encodeLL([t],l,n,1,0,8);window.open(URL.createObjectURL(new Blob([i],{type:"image/png"})),"_blank").focus(),T()})};if(C)l();else{async function n(e,t){let l=document.createElement("script");l.src=e,l.onload=t,document.body.appendChild(l)}n("/thirdparty/UZIP.min.js",function(){n("/thirdparty/pako.min.js",function(){n("/thirdparty/UPNG.min.js",function(){C=!0,l()})})})}},I.onclick=()=>{k(),t.getBc4Compressed().then(e=>{window.open(URL.createObjectURL(new Blob([e.buffer],{type:"application/octet-stream"})),"_blank").focus(),T()})},(B=()=>{0==t.getIteration()&&(w.disabled=!0,I.disabled=!0);let e=t.isDone();t.redraw(),window.requestAnimationFrame(B);let l=document.getElementById("progressBar");document.getElementById("progressPercent");let n=t.getProgress();l.style.width=`${100*n}%`,progressPercent.innerHTML=`${Math.round(100*n)}%`,t.isDone()!=e&&(w.disabled=!1,I.disabled=!1)})()})});</script> <hr id=footersep> <div id=copyright>With the exception of third-party libraries / resources, code is public domain. Text &copy; Alister Chowdhury.</div> </body></html>