import{AsyncBarrier as e,loadCommonShaderSource as t,createShader as r,createGraphicsProgram as a,getUniformLocation as E,deleteShaders as n,loadF32Lines as R}from"../../util.js";function loadShaderSource(e){return fetch("./shaders/compiled/"+e).then(e=>e.text())}let _BVH1_DATA=new e().enqueue(R("/res/lines.f32"),"DEFAULT_LINES").enqueue(WebAssembly.instantiateStreaming(fetch("/res/bvh_v1.wasm")).then(e=>e.instance.exports),"BVH_V1"),_GLOBAL_SHADERS_DATA=new e().enqueue(t("draw_full_screen_uvs.vert"),"DRAW_FULL_SCREEN_UVS_VERT"),_RESOURCES=new e().enqueue(_BVH1_DATA.selfBarrier(),null,["DEFAULT_LINES","BVH_V1"]).enqueue(_GLOBAL_SHADERS_DATA.selfBarrier(),null,["DRAW_FULL_SCREEN_UVS_VERT"]).enqueue(t("draw_col.frag"),"V1_DRAW_BVH_FRAG_SRC").enqueue(loadShaderSource("v1_draw_bvh_all.vert"),"V1_DRAW_BVH_ALL_VERT_SRC").enqueue(loadShaderSource("v1_draw_bvh_bbox.vert"),"V1_DRAW_BVH_BBOX_VERT_SRC").enqueue(loadShaderSource("v1_draw_bvh_lines.vert"),"V1_DRAW_BVH_LINES_VERT_SRC").enqueue(loadShaderSource("v1_tracing_test_composite.frag"),"V1_TRACING_TEST_COMPOSITE_FRAG_SRC").enqueue(loadShaderSource("v1_tracing_test_line_id.frag"),"V1_TRACING_TEST_LINE_ID_FRAG_SRC").enqueue(loadShaderSource("v1_tracing_test_num_intersections.frag"),"V1_TRACING_TEST_NUM_INTERSECTIONS_FRAG_SRC").enqueue(loadShaderSource("v1_tracing_test_num_visits.frag"),"V1_TRACING_TEST_NUM_VISITS_FRAG_SRC").enqueue(loadShaderSource("v1_tracing_test_visibility.frag"),"V1_TRACING_TEST_VISIBILITY_FRAG_SRC").enqueue(loadShaderSource("v1_tracing_test_pointlight.frag"),"V1_TRACING_TEST_POINTLIGHT_FRAG_SRC");export function generateBVH(e){let t=_BVH1_DATA.BVH_V1,r=e.length/4;if(!t.allocateLines(r)){var a=`Failed to allocate lines (num: ${r}).`;throw console.log(a),alert(a),Error(a)}new Float32Array(t.memory.buffer,t.getLinesBuffer(),e.length).set(e);let E=t.buildBvh(r);if(!E){var a="Failed to build BVH!";throw console.log(a),alert(a),Error(a)}return new Float32Array(t.memory.buffer,t.getBvhBuffer(),12*E)}class BvhV1CanvasContext{constructor(e){let t=e.getContext("webgl2",{alpha:!1,depth:!1});if(this.canvas=e,this.valid=!!t,this.redraw=()=>{},!this.valid)return;let R=this;this.resourceLoaded=_RESOURCES.then(()=>{let i=r(t,_RESOURCES.DRAW_FULL_SCREEN_UVS_VERT,t.VERTEX_SHADER),T=r(t,_RESOURCES.V1_DRAW_BVH_FRAG_SRC,t.FRAGMENT_SHADER),S=r(t,_RESOURCES.V1_DRAW_BVH_ALL_VERT_SRC,t.VERTEX_SHADER),u=r(t,_RESOURCES.V1_DRAW_BVH_BBOX_VERT_SRC,t.VERTEX_SHADER),o=r(t,_RESOURCES.V1_DRAW_BVH_LINES_VERT_SRC,t.VERTEX_SHADER),l=r(t,_RESOURCES.V1_TRACING_TEST_COMPOSITE_FRAG_SRC,t.FRAGMENT_SHADER),s=r(t,_RESOURCES.V1_TRACING_TEST_LINE_ID_FRAG_SRC,t.FRAGMENT_SHADER),d=r(t,_RESOURCES.V1_TRACING_TEST_NUM_INTERSECTIONS_FRAG_SRC,t.FRAGMENT_SHADER),v=r(t,_RESOURCES.V1_TRACING_TEST_NUM_VISITS_FRAG_SRC,t.FRAGMENT_SHADER),A=r(t,_RESOURCES.V1_TRACING_TEST_VISIBILITY_FRAG_SRC,t.FRAGMENT_SHADER),h=r(t,_RESOURCES.V1_TRACING_TEST_POINTLIGHT_FRAG_SRC,t.FRAGMENT_SHADER),V=a(t,S,T),_=a(t,u,T),c=a(t,o,T),C=a(t,i,l),D=a(t,i,s),L=a(t,i,d),U=a(t,i,v),g=a(t,i,A),B=a(t,i,h);[V,_,c,C,D,L,U,g,B].forEach(e=>{e.loc={}}),[V,_,c,C,D,L,U,g,B].forEach(e=>{e.loc.v1LinesBvh=E(t,e,"v1LinesBvh")}),[C,D,L,U,g,B].forEach(e=>{e.loc.targetUV=E(t,e,"targetUV")}),n(t,i,T,S,u,o,l,s,d,v,A,h);let I=e=>{void 0!=R.bvhData&&null!=R.bvhData.texture&&(t.deleteTexture(R.bvhData.texture),R.bvhData.texture=null),void 0!=e&&e.length||(e=new Float32Array([1/0,1/0,1/0,1/0]));let r=e.length/4,a=generateBVH(e),E=a.length/4,n=E/3,i=t.createTexture();t.bindTexture(t.TEXTURE_2D,i),t.texImage2D(t.TEXTURE_2D,0,t.RGBA32F,E,1,0,t.RGBA,t.FLOAT,a),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST),R.bvhData={numLines:r,numFloat4:E,numEntries:n,texture:i}},f=()=>{t.bindFramebuffer(t.FRAMEBUFFER,null),t.drawBuffers([t.BACK]),t.viewport(0,0,e.width,e.height)},N=()=>{(e.width!==e.clientWidth||e.height!==e.clientHeight)&&(e.width=e.clientWidth,e.height=e.clientHeight,f())},G=()=>{N();{let e=null;switch(R.rayVisMode){case 0:e=B;break;case 1:e=g;break;case 2:e=L;break;case 3:e=U;break;case 4:e=C;break;default:e=D}t.useProgram(e),t.activeTexture(t.TEXTURE0),t.bindTexture(t.TEXTURE_2D,R.bvhData.texture),t.uniform1i(e.loc.v1LinesBvh,0),t.uniform2f(e.loc.targetUV,R.visTargetUV[0],R.visTargetUV[1]),t.drawArrays(t.TRIANGLES,0,3)}if(R.drawBvhOverlayMode>0){let r=null;switch(R.drawBvhOverlayMode){case 1:r=c;break;case 2:r=_;break;default:r=V}t.useProgram(r),t.activeTexture(t.TEXTURE0),t.bindTexture(t.TEXTURE_2D,R.bvhData.texture),t.uniform1i(r.loc.v1LinesBvh,0),t.drawArrays(t.LINES,0,16*R.bvhData.numEntries)}};R.drawBvhOverlayMode=1,R.rayVisMode=0,R.visTargetUV=[.4,.6],R.allowWallClipping=!0,e.width=e.clientWidth,e.height=e.clientHeight;let m=_RESOURCES.BVH_V1;f(),I(_RESOURCES.DEFAULT_LINES),G();let w=(t,r)=>{t.preventDefault();let a=e.getBoundingClientRect(),E=r?[t.touches[0].clientX,t.touches[0].clientY]:[t.clientX,t.clientY],n=[(E[0]-a.x)/a.width,1-(E[1]-a.y)/a.height];!R.allowWallClipping&&m.traceBvh(R.visTargetUV[0],R.visTargetUV[1],n[0]-R.visTargetUV[0],n[1]-R.visTargetUV[1],1,0)&&(n=R.visTargetUV),R.visTargetUV=n,G()},F=t=>{if("mousedown"==t.type){let r=e=>{w(e,!1)},a=t=>{t.preventDefault(),e.removeEventListener("mousemove",r,!1),e.removeEventListener("mouseup",a,!1)};e.addEventListener("mousemove",r,!1),e.addEventListener("mouseup",a,!1),r(t)}else{let E=e=>{w(e,!0)},n=t=>{t.preventDefault(),e.removeEventListener("touchmove",E,!1),e.removeEventListener("touchend",n,!1)};e.addEventListener("touchmove",E,!1),e.addEventListener("touchend",n,!1),E(t)}};e.addEventListener("mousedown",F,!1),e.addEventListener("touchstart",F,!1),R.updateGpuBvhTexture=I,R.redraw=G})}}export function getDefaultLines(){return _BVH1_DATA.DEFAULT_LINES}export function bindBvh1Context(e){return void 0==e.drawCtx&&(e.drawCtx=new BvhV1CanvasContext(e)),e.drawCtx}export function onResourcesLoaded(e){return _RESOURCES.then(e)}export function onBvh1DataLoaded(e){return _BVH1_DATA.then(e)}